{% macro live_chart(chart_id, user_id="default", chart_type="chart_1_update") %}
<div class="chart-card">
    <h2>{{ chart_id | replace('chart', 'Chart ') | upper }}</h2>
    <div class="chart-container">
        <canvas id="{{ chart_id }}"></canvas>
    </div>

    <script>
        (function () {
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            const host = window.location.host;
            const chartType = "{{ chart_type }}";
            const chartId = "{{ chart_id }}";

            // One WebSocket per user session (SessionMiddleware handles auth)
            const ws = new WebSocket(`${protocol}//${host}/ws`);

            const ctx = document.getElementById(chartId);
            const chart = new Chart(ctx, {
                type: "line",
                data: {
                    datasets: [{
                        label: "Simulation Value",
                        data: [],
                        tension: 0.4,
                        borderColor: "#667eea",
                        backgroundColor: "rgba(102, 126, 234, 0.1)",
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: "#667eea",
                        pointBorderColor: "#fff",
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0,
                            max: 4,
                            grid: { color: "rgba(0, 0, 0, 0.05)" },
                            title: { display: true, text: "Value" }
                        },
                        x: {
                            type: "linear",
                            position: "bottom",
                            min: 0,
                            max: 50,
                            ticks: { stepSize: 10 },
                            title: { display: true, text: "Time (seconds)" },
                            grid: { color: "rgba(0, 0, 0, 0.05)" }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: "top" }
                    }
                }
            });

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                try {
                    // Route by message type
                    if (msg.type === chartType) {
                        chart.data.datasets[0].data.push({ x: msg.time, y: msg.value });
                        if (chart.data.datasets[0].data.length > 50) {
                            chart.data.datasets[0].data.shift();
                        }
                        chart.options.scales.x.min = chart.data.datasets[0].data[0].x;
                        chart.options.scales.x.max = chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1].x;
                        chart.update("none");
                    } else if (msg.type === "file_update") {
                        console.log("File updated event:", msg.event);
                    }
                } catch (e) {
                    console.error("Error processing message:", e, msg);
                }
            };

            ws.onopen = () => console.log("WebSocket connected for " + chartType);
            ws.onclose = () => console.log("WebSocket closed");
            ws.onerror = (e) => console.error("WebSocket error:", e);
        })();
    </script>
</div>
{% endmacro %}